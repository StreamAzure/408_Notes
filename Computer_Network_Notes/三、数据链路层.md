

# 三、数据链路层

## 3.1 基本概念

> 协议数据单元——帧

为网络层交付下来的网络层协议数据单元（在互联网中就是 IP 数据报）**添加首部和尾部**，就构成了**帧**。

> 数据链路 链路

- 链路：一段点到点的物理线路，中间没有任何其他节点。主机与主机之间通信的路径通常由许多条这样链路构成。
- 数据链路：具备实现通信协议的硬件和软件（如网络适配器）的链路。

## 3.2 需要解决的三大问题

> 封装成帧

在一段数据的前后添加首部和尾部。

作用：

- 帧定界：首部和尾部可标识一个帧的起始和结束
- 控制信息

当数据为可打印的 ACSII 码构成的文本文件时，帧定界使用特殊的帧定界符：SOH 和 EOT。

> 透明传输

问题：当数据为非 ACSII 码构成的文本文件时（如程序和图像），数据中可能包含与帧定界符相同的二进制代码，导致数据链路层错误识别。

解决：因为数据链路层应实现**透明传输**，即需要保证无论什么样的数据都可以传输，所以对于上述情况，数据链路层必须采取措施使得数据同样可以传输（而不是直接拒绝这种数据）。所使用的措施就是**字节填充**（也成为**字符填充**），具体方法是：发送端在数据中的 SOH / EOT 字符前面插入一个转义字符“ESC”，使得数据不会被错误解释。接收端删除这些转义字符后再将数据上交给网络层。如果数据中也有 ESC 字符，则同样在前面再插入一个 ESC 字符。

> 差错检测

问题：传输过程中会出现比特差错，如 0 变成 1 ，1 变成 0。

解决：数据链路层通过**循环冗余检验 CRC** 检测差错，具体方法是：

1. 将数据划分成组，每组 k 个比特，用 M 表示其中一组

2. 双方事先约定一个 n+1 位的除数 P ，在 M 后面添加 n 个 0，扩充至 k+n 位

3. 计算 M 对 P 取模，所得余数 R 一定为 n 位，将 R 与 M 做二进制加法，最终得到 k+n 位的 M'，发送。

   ![25FAB8B0316EFC4DF4393C1AEBB43394](C:\Users\18372\Documents\Tencent Files\1905105036\FileRecv\MobileFile\25FAB8B0316EFC4DF4393C1AEBB43394.png)

4. 接收方以帧为单位进行 CRC 检验，将收到的每个帧除以 P 。若帧无差错，则所得余数必为 0，若不为 0 则表示帧存在差错。注意，当帧存在差错时，所得余数也有可能为 0 ，但只要 P 经过认真挑选，这种概率是非常非常小的。

概念：

- 为了差错检测而添加的这n 位冗余码称为**帧检测序列（FCS）**

局限：

​		若数据链路层仅采用 CRC ，那么只能保证对帧的**无差错接受**，即被接受的帧可以认为几乎没有差错，有差错的帧都已经被丢弃了，没有接受。

​		注意，这没有实现可靠传输，因为它仅仅检测了比特差错这一种情况。传输过程还会出现其他差错，如帧失序、帧重复、帧丢失等，必须都具有应对手段才能说提供了可靠传输服务。

​		对于通讯质量良好的有线传输链路，数据链路层**不向上提供可靠传输服务**；对于通讯质量较差的无线传输链路，数据链路层**向上提供可靠传输服务**。这样的区别对待可以提高通信效率。

## 3.3 协议

### 3.3.1 点对点协议 PPP

#### 3.3.1.1 PPP 协议特点

（1）应满足的需求

- 简单
- 封装成帧
- 透明传输
- 差错检测
- 多种网络层协议
- 多种类型链路（串行的或并行的，同步的或异步的，电的或光的，低速的或高速的点对点链路）
- 检测连接状态：PPP 需要具备对链路工作状态的及时检测功能
- 最大传输单元
- 网络层地址协商：必须提供一种机制使得两个网络层的实体可以互相知道网络层地址
- 数据压缩协商：必须提供一种机制协商数据压缩算法

（2）组成

- 一个将IP数据报封装到串行链路的方法
- 链路控制协议LCP，用于建立、配置和测试数据链路连接
- 网络控制协议NCP，用于支持不同的网络层协议

#### 3.3.1.2 PPP 协议格式

（1）信息部分

通常为网络层交付的IP数据报，长度可变但有上限，上限称为MTU，默认1500字节。

（2）首部

首部的第1个字段（1字节）为标志字段，表示一个帧的开始，值规定为0x7E

首部的第2、3个字段（各1字节）为地址字段和控制字段，值分别规定0xFF和0x03，保留字段，无意义

首部的第4个字段（2字节）为协议字段，表示该帧信息字段的协议类型

（3）尾部

尾部的第1个字段（2字节）为使用CRC的帧检验序列FCS

（4）填充

异步传输时，使用**字节填充**。转义符为0x7D，填充方法如下：

- 信息字段中的0x7E字节转变为0x7D,0x5E
- 信息字段中的0x7D字节转变为0x7D,0x5D
- 其他ASCII码的控制字符，在前面加入0x7D，同时该字符编码改变

同步传输时，使用**零比特填充**。发送端扫描整个信息字段（通常用硬件实现），在每五个连续的1后填入一个0，使信息字段中不会出现连续的六个1。

#### 3.3.1.3 PPP协议工作过程

**（链路静止状态）**用户拨号接入ISP → 建立物理连接**（链路建立状态）**

**（链路建立状态）**用户发送LCP分组（被封装为多个PPP协议帧） →　建立LCP连接**（鉴别状态）**

**（鉴别状态）**只允许传送LCP协议分组、鉴别协议分组、监测链路质量的分组；口令鉴别协议PAP与更复杂的口令握手鉴别协议CHAP。鉴别失败则转入**（链路终止状态）**，成功则转入**（网络层协议状态）**

**（网络层协议状态）**根据PPP链路上运行的协议类型，使用NCP中的对应支持协议进行配置，如IP协议对应的是IP控制协议IPCP，配置双方的IP协议模块（如分配IP地址） **（链路打开状态）**

**（链路打开状态）**关闭请求或链路故障**（链路终止状态）**

**（链路终止状态）**LCP链路终止，即调制解调器的载波停止**（链路静止状态）**

### 3.3.2 以太网

#### 3.3.2.1 前置概念

> 局域网

- 网络为一个单位所拥有，且地理范围和站点数目均有限
- 具有**广播功能**，局域网上的主机可以共享连接在局域网上的各种硬件和软件资源
- 分类：星形网（使用集线器）、环形网、总线网
- 以太网现在已成为局域网的同义词

> 计算机如何接入互联网

- 通过适配器，即网卡
- 适配器的一个重要功能是进行数据串行传输和并行传输的转换（对内通过I/O总线并行传输，对外通过电缆、双绞线串行传输）
- 计算机的**硬件地址存储在适配器**的ROM中，IP存储在计算机存储器中

#### 3.3.2.2 以太网的网络拓扑

- 以太网使用集线器（hub）构成星形拓扑，在物理上是个星形网
- 集线器使用电子器件模拟实际电缆的工作，使得**以太网在逻辑上是个总线网，各站共享逻辑上的总线**，各站中的适配器执行CSMA/CD协议。同一时刻至多允许一个站发送数据。
- 集线器有许多端口，每个端口用 2 对双绞线与一台计算机的适配器相连
- **集线器工作在物理层**，每个端口仅仅是简单地转发比特，不进行碰撞检测。
- 光纤主要用于集线器之间的远程连接

#### 3.3.2.3 以太网的信道利用率 

（1）提高信道利用率所要做到的

假设发送一个帧所需的时间为$T_0$，则成功发送一个帧（即对方成功收到）需要占用信道的时间为$T_0+\tau$。
$$
a = \frac{\tau}{T_0}
$$
当$a\rightarrow0$时，只要一发生碰撞就会被立即检测到。$a$越大，则争用期占比越大，只要发生一次碰撞就会浪费不少的信道资源。因此$a$应该尽量小。

为使得$a$尽量小，一方面要使得$\tau$尽量小，即数据率一定时，**以太网的连线的长度有限**（减小传播时延）；另一方面要使得$T_0$尽可能大，即**以太网的帧长不能太短**。

（2）极限信道利用率

最理想化情况下，以太网上的数据不会发生碰撞，且一有空闲立即发送数据，那么此时的信道利用率为
$$
S_{max} = \frac{T_0}{T_0+\tau} =\frac{1}{1+a}
$$
上式表明，只有当$a$远小于1时，极限信道利用率才会尽可能高。

#### 3.3.2.4 以太网帧格式

（1）MAC地址

- 48位（6字节），固化在适配器的ROM中
- 最低第1位为I/G位（Individual/Group），为0时，该地址表示单个站地址；为1时表示组地址
- 最低第2位为G/L位（Global/Local），为0时，全球管理，保证全球唯一；为1时本地管理，用户可任意分配
- 全1，广播地址

（2）帧格式

- 不算MAC帧的部分：硬件生成的8个字节，前7个为前同步码，用于接收方适配器调整时钟频率；最后1个为帧开始定界符，值为10101011，前六位作用与前同步码一样，最后两个1通知适配器MAC帧即将到达。
- 首部字段1：6字节，目的地址
- 首部字段2：6字节，源地址
- 首部字段3：2字节，类型，标志上一层使用的协议类型
- 数据字段：长度范围[46，1500]；最小值46字节=最小总帧长64字节-14字节的首部-4字节的尾部；最大值即MTU值。当数据字段过短导致总帧长小于64自己时，在数据字段的末尾填充。
- 尾部字段：4字节，CRC检验得出的帧检验序列FCS，其检验范围从目的地址字段开始，到FCS本身结束。

（3）无效MAC帧

- 数据字段的长度与长度字段的值不一致；
- 帧的长度不是整数个字节；
- 用收到的帧检验序列 FCS 查出有差错；
- 数据字段的长度不在 46 ~ 1500 字节之间。
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间。

（4）无效MAC帧的处理方式

**直接丢弃。**

### 3.3.3  广播信道协议 CSMA/CD

#### 3.3.3.1 前置概念

> 多点接入

总线型网络，所有计算机连接在一根总线上

> 载波监听

实质上是媒介监听，即发送数据前和发送数据中都不停地检测信道是否有其他主机发送数据（注意，没有发送完毕之后的检测，这会造成问题，具体见下），如果有，立即中止本站的发送

> 碰撞检测

- 争用期

  **至多**经过多久后站点得知自己发送的数据是否发生碰撞。最坏情况下，两站点位于总线的两端（距离最远），站点发出的数据帧在将到达目的站点时（此时已经过了时间$\tau$，$\tau$为总线传播时延），目的站点恰好发出数据，发生碰撞，碰撞信息再经过时间$\tau$回传给站点。故从站点发送数据开始计时，最多经过时间$2\tau$，站点可得知自己发送的数据是否发生碰撞。

  这个时间$2\tau$即争用期/碰撞窗口。一个站点发出的数据要经过争用期的“考验”，才能确定是否到达目的站点，若过了争用期还没有发生碰撞，则本次传输的数据都不会发生碰撞。

- 如果碰撞，何时重传？

  截断二进制指数退避算法，使得发生碰撞的站在等待一个随机的时间后再发送数据。

  这个算法规定，基本退避时间为争用期$2\tau$，具体的争用期时间为$51.2\mu s$，对于速率为10Mbit/s的以太网，在争用期内可发送512bit，即64字节（如果一切顺利没有发生碰撞）

- 无效帧

  - 问题：上述假设的情况有一个前提：在发生碰撞时，站点仍在发送数据。这种情况下，发送站能检测到碰撞。但如果数据量非常小，且发送完毕前没有检测到碰撞，在发送完毕之后，这个数据量很小的帧又在传播过程中发生了碰撞，则发送站无从知晓（因为已经发送完了，不检测）这个帧是否正确到达了目的站点。
  - 解决：规定一个最短帧长64字节，若数据量小于64字节则进行填充以达到要求。根据前文，争用期内可发送64字节，若发生碰撞，一定会在前64字节内。将最短帧长规定为64字节，即可保证发生碰撞时站点仍在发送数据，从而站点可检测到碰撞。
  - 站点一旦检测到碰撞立即终止发送，则已经发送的数据一定小于64字节，那么根据最短帧长限制，可以认为小于64字节的数据都是发生了碰撞的无效数据，即**无效帧**，直接丢弃即可

- 以太网的实际端对端长度

  争用期时间51.2$\mu s$是个规定值，这意味着投入使用的以太网总线的传播时延应该小于争用期的一半25.6$\mu s$。已知信号在以太网上传播1km需要5$\mu s$，要符合上述传播时延要求，以太网的最大端对端长度应不大于5km。而实际投入使用的以太网覆盖范围远远没有这么大，即使算上转发器等造成的时延，也是能符合争用期时间要求的。

> 强化碰撞

- 目的：当发送碰撞时，除了发送站能检测到发生碰撞，也要使总线上的其他站点也能检测到发生碰撞
- 方法：发送站检测到发生碰撞，立即停止发送数据，转而发送人为干扰信号（32bit或48bit，对于速率为10Mbit/s的以太网，发送时间为3.2$\mu s$或4.8$ \mu s$）
- 信道占用时间：假设发送数据后经过时间$T_B$检测到发生碰撞并停止发送，再经过时间$T_J$将人为干扰信号发送完毕，人为干扰信号再经过传播时延$ \tau$传播到整个总线，因此总的占用时间为$T_B+T_J+\tau$

> 帧间最小间隔

- 目的：留给接收站处理帧数据的时间
- 值：9.6$ \mu s$

#### 3.3.3.2 CSMA/CD 协议要点

1. 准备发送

   适配器按数据链路层要求将网络层数据封装成以太网帧（以太网帧格式见后文），放入适配器缓存，并检测信道。

2. 检测信道

   检测到信道忙，则一直检测直至信道空闲，由于帧间最小间隔的存在，在检测到信道空闲后还需要继续确认持续9.6$\mu s$的空闲状态，然后再发送数据。

3. 边发送边监听

   - 情况1：争用期内未检测到碰撞，视为数据发送成功，什么都不做，回到1

   - 情况2：争用期内检测到碰撞，立即中止发送，并发送人为干扰信号。然后执行指数退避算法，回到2尝试重传。若重传达16次仍未成功，则停止重传，向上报错。

## 3.4 扩展以太网

（1）物理扩展

使用光纤扩展。但这会导致碰撞域扩展，总的吞吐量并未提高。且数据率不同就不能用集线器扩展

（2）数据链路层扩展

- 二层交换机（交换式集线器/以太网交换机），工作在数据链路层

- 工作原理：自学习。若交换表中没有帧的源地址，则将源地址、接口、有效时间加入交换表；若交换表中没有帧的目的地址，则向其他接口广播。交换表中的每一项都存在有效时间，一旦过期自动删除
- 生成树协议STP：避免了以太网帧在网络环路中绕圈。
- 交换机不使用共享总线，没有碰撞问题，不使用CSMA/CD协议

## 3.5 虚拟局域网

（1）VLAN 标签

- 在以太网帧格式，源地址字段之后、类型字段之前插入一个4字节的字段，作为VLAN标识符。

- 拥有VLAN标识符的有以太网帧称为802.1Q帧
- VLAN标识符前2字节为固定的0x8100，后2个字节的前4位无用，后12位为VID
- 插入VLAN标签后，需要重新计算FCS

（2）工作过程

假设主机A、主机B分别接入两个交换机#1和#2，同属一个虚拟局域网VLAN10.

当主机A向主机B发送以太网帧时，#1给来自主机A的以太网帧插入VLAN标签，通过汇聚链路发送到#2；#2收到带有VLAN标签的以太网帧，取走VLAN标签后再转发给主机B。

## 3.6 高速以太网

- 高速以太网：速率≥100Mbit/s
- 快速以太网：在双绞线上传送 100 Mbit/s 基带信号的星形拓扑以太网，仍使用 IEEE 802.3 的 CSMA/CD 协议。

- 吉比特以太网： 1Gbit/s 全双工和半双工两种方式